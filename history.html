from http.server import BaseHTTPRequestHandler
import json
import os
import requests
from supabase import create_client

class handler(BaseHTTPRequestHandler):
def do_POST(self):
try:
content_len = int(self.headers.get('Content-Length'))
data = json.loads(self.rfile.read(content_len))
user_id = data.get('user_id')

MERCHANT_KEY = os.environ.get('OXAPAY_MERCHANT_KEY')
SUPABASE_URL = os.environ.get('SUPABASE_URL')
SUPABASE_KEY = os.environ.get('SUPABASE_KEY')
supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

# 1. 注文履歴を取得
orders = supabase.table('orders').select('*').eq('user_id', user_id).order('created_at', desc=True).execute().data

updated_orders = []

for order in orders:
# 2. 「待機中」なら、強制的にOxapayに最新状況を聞きに行く
if order['status'] == 'pending':
try:
# Oxapay APIへ問い合わせ
url = "https://api.oxapay.com/merchants/inquiry"
payload = {"merchant": MERCHANT_KEY, "orderId": order['order_id']}
res = requests.post(url, json=payload).json()

payment_status = res.get('status') # Paid, Waiting, Confirming...

# ★ 支払い済み (Paid) だった場合
if payment_status == 'Paid':
# キーの引き当て（まだ無ければ）
if not order.get('license_key'):
key_res = supabase.rpc('claim_license_key', {
'p_plan_type': order['plan_type'],
'p_buyer_id': user_id
}).execute()

license_key = key_res.data
if not license_key:
license_key = "在庫切れ (管理者に連絡してください)"

# DB更新
supabase.table('orders').update({
'status': 'paid',
'license_key': license_key
}).eq('id', order['id']).execute()

# 表示用にデータを書き換える
order['status'] = 'paid'
order['license_key'] = license_key
else:
# キーはあるけどステータスが古い場合
supabase.table('orders').update({'status': 'paid'}).eq('id', order['id']).execute()
order['status'] = 'paid'

# ★ 期限切れ (Expired) だった場合
elif payment_status == 'Expired':
supabase.table('orders').update({'status': 'expired'}).eq('id', order['id']).execute()
order['status'] = 'expired'

except Exception as e:
print(f"Check Error for {order['order_id']}: {e}")
# エラーでもリストには含める

updated_orders.append(order)

# 3. 結果を返す
self.send_response(200)
self.send_header('Content-type', 'application/json')
self.end_headers()
self.wfile.write(json.dumps(updated_orders).encode())

except Exception as e:
self.send_response(500)
self.end_headers()
self.wfile.write(json.dumps({"error": str(e)}).encode())