<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="history_title"></title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="/common.css">
    <style>
        .container {
            width: 90%;
            max-width: 800px;
            margin-top: 30px
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto
        }

        .filter-btn {
            background: #111;
            border: 1px solid #333;
            color: #ccc;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer
        }

        .filter-btn.active {
            background: #00E701;
            color: #000;
            font-weight: bold
        }

        .history-card {
            background: #111;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="border-bottom:1px solid #333;padding-bottom:15px;color:#00E701" data-i18n="history_title"></h1>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="fH('all',this)" data-i18n="filter_all"></button><button
                class="filter-btn" onclick="fH('paid',this)" data-i18n="filter_paid"></button>
            <button class="filter-btn" onclick="fH('pending',this)" data-i18n="filter_pending"></button><button
                class="filter-btn" onclick="fH('expired',this)" data-i18n="filter_expired"></button>
        </div>
        <div id="history-list">
            <p style="text-align:center;color:#666" data-i18n="notif_loading"></p>
        </div>
    </div>
    <script src="/setting.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded',async()=>{if(!window.supabaseApp)await new Promise(r=>setTimeout(r,1000));const {data:{session}}=await window.supabaseApp.auth.getSession();if(session)loadH(session.user.id);else document.getElementById('history-list').innerHTML="Login required."});
        async function loadH(uid){const res=await fetch('/api/history',{method:'POST',body:JSON.stringify({user_id:uid})});const os=await res.json();const l=document.getElementById('history-list');l.innerHTML="";if(os.length===0){l.innerHTML=`<p style="text-align:center" data-i18n="history_empty">${t('history_empty')}</p>`;return}os.forEach(o=>{const d=document.createElement('div');d.className=`history-card item-${o.status}`;d.onclick=()=>location.href=`/checkout/${o.order_id}`;let txt,clr;if(o.status==='paid'){txt=currentLang==='ja'?'完了':'Done';clr='#00E701'}else if(o.status==='pending'){txt=currentLang==='ja'?'確認中':'Pending';clr='#ffd700'}else{txt=currentLang==='ja'?'キャンセル':'Cancelled';clr='#ff4444'}d.innerHTML=`<div><b>${o.plan_type.toUpperCase()} PLAN</b><br><small>ID: ${o.order_id}</small></div><div style="color:${clr}">${txt} ></div>`;l.appendChild(d)})}
        function fH(t,b){document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');document.querySelectorAll('.history-card').forEach(i=>{i.style.display=(t==='all'||i.classList.contains(`item-${t}`))?'flex':'none'})}
    </script>
</body>

</html>