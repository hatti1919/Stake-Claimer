<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="dash_title">Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/common.css">
    <style>
        .container {
            width: 90%;
            max-width: 800px;
            margin-top: 30px;
            margin-bottom: 50px
        }

        .card {
            background: #111;
            border: 1px solid #333;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .5)
        }

        .section-title {
            color: #00E701;
            font-size: 1.3rem;
            margin-bottom: 20px;
            border-left: 4px solid #00E701;
            padding-left: 10px;
            font-weight: bold
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px
        }

        .status-item {
            background: #000;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #222
        }

        .status-label {
            color: #888;
            font-size: .9rem;
            margin-bottom: 5px
        }

        .status-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff
        }

        .active-badge {
            display: inline-block;
            background: rgba(0, 231, 1, .15);
            color: #00E701;
            padding: 2px 10px;
            border-radius: 15px;
            font-size: .8rem;
            border: 1px solid #00E701
        }

        .expired-badge {
            background: rgba(255, 68, 68, .15);
            color: #ff4444;
            border: 1px solid #ff4444
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 102, 255, .1);
            border: 1px solid #0066ff;
            padding: 15px;
            border-radius: 8px
        }

        .acc-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-weight: bold
        }

        .acc-icon {
            color: #0066ff;
            font-size: 1.2rem
        }

        .del-btn {
            background: #ff4444;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: .8rem
        }

        .input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px
        }

        .key-input {
            flex: 1;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-size: 1rem;
            font-family: monospace;
            min-width: 250px
        }

        .action-btn {
            background: #00E701;
            color: #000;
            font-weight: bold;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: .3s
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 style="border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:30px"><i
                class="fa-solid fa-gauge-high" style="color:#00E701"></i> <span data-i18n="dash_title"></span></h1>
        <div class="card">
            <div class="section-title" data-i18n="status_title"></div>
            <div id="loading-status" style="text-align:center;color:#666" data-i18n="notif_loading"></div>
            <div id="status-content" class="status-grid" style="display:none">
                <div class="status-item">
                    <div class="status-label" data-i18n="plan_label"></div>
                    <div class="status-value" id="disp-plan">---</div>
                </div>
                <div class="status-item">
                    <div class="status-label" data-i18n="state_label"></div>
                    <div class="status-value" id="disp-badge">---</div>
                </div>
                <div class="status-item" style="grid-column:1/-1">
                    <div class="status-label" data-i18n="expiry_label"></div>
                    <div class="status-value" id="disp-date" style="font-family:monospace;color:#00E701">---</div>
                </div>
            </div>
        </div>
        <div class="card" style="border-color:#0066ff">
            <div class="section-title" style="color:#0066ff;border-left-color:#0066ff" data-i18n="stake_link_title">
            </div>
            <div id="account-list-area" class="account-list"></div>
            <div style="text-align:right;color:#888;font-size:.9rem;margin-top:5px"><span
                    data-i18n="linked_acc_label"></span>: <span id="acc-count">0</span> / <span
                    data-i18n="limit_label"></span>: <span id="acc-limit">1</span></div>
            <div id="add-form" style="margin-top:20px;border-top:1px solid #333;padding-top:20px">
                <div class="input-group"><input type="password" id="stake-api-key" class="key-input"
                        data-i18n-placeholder="add_acc_placeholder" autocomplete="off"><button class="action-btn"
                        style="background:#0066ff;color:#fff" onclick="verifyStakeKey()" data-i18n="link_btn"></button>
                </div>
            </div>
            <div id="limit-msg" style="display:none;text-align:center;color:#ff4444;margin-top:20px;font-weight:bold"
                data-i18n="limit_reached"></div>
        </div>
        <div class="card">
            <div class="section-title" data-i18n="license_activate_title"></div>
            <div class="input-group"><input type="text" id="license-key" class="key-input"
                    data-i18n-placeholder="license_placeholder"><button class="action-btn" onclick="activateLicense()"
                    data-i18n="activate_btn"></button></div>
        </div>
    </div>
    <script src="/setting.js"></script>
    <script>
        let dId=null; window.addEventListener('DOMContentLoaded',async()=>{if(!window.supabaseApp)await new Promise(r=>setTimeout(r,1000));const {data:{session}}=await window.supabaseApp.auth.getSession();if(session){dId=session.user.user_metadata.provider_id||session.user.id;loadStatus(dId)}else{showModal(t('modal_err'),t('modal_login_req'),[{text:"OK",onClick:()=>location.href="/"}])}});
        async function loadStatus(id){try{const res=await fetch('/api/user_status',{method:'POST',body:JSON.stringify({discord_id:id})});const d=await res.json();document.getElementById('loading-status').style.display='none';document.getElementById('status-content').style.display='grid';document.getElementById('disp-plan').innerText=d.active?d.plan_name:(currentLang==='ja'?"未加入":"None");document.getElementById('disp-badge').innerHTML=d.active?`<span class="active-badge">${t('active_status')}</span>`:`<span class="active-badge expired-badge">${t('inactive_status')}</span>`;document.getElementById('disp-date').innerText=d.active?new Date(d.expires_at).toLocaleString():"---";const l=document.getElementById('account-list-area');l.innerHTML="";const accs=d.linked_accounts||[];document.getElementById('acc-count').innerText=accs.length;document.getElementById('acc-limit').innerText=d.account_limit||1;if(accs.length>0){accs.forEach(a=>{l.innerHTML+=`<div class="account-item"><div class="acc-info"><i class="fa-solid fa-user-tag acc-icon"></i><span>${a.username}</span></div><button class="del-btn" onclick="delAcc()">${t('delete_btn')}</button></div>`})}else{l.innerHTML=`<div style="text-align:center;color:#666">${currentLang==='ja'?'未連携':'None'}</div>`}if(accs.length>=(d.account_limit||1)){document.getElementById('add-form').style.display='none';document.getElementById('limit-msg').style.display='block'}else{document.getElementById('add-form').style.display='block';document.getElementById('limit-msg').style.display='none'}}catch(e){}}
        async function verifyStakeKey(){const k=document.getElementById('stake-api-key').value;if(!k)return;const btn=document.querySelector('.action-btn');btn.disabled=true;try{const res=await fetch('/api/verify_stake',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({discord_id:dId,api_key:k})});if(res.ok){loadStatus(dId)}else{const d=await res.json();showModal(t('modal_err'),d.error)}}catch(e){}finally{btn.disabled=false}}
        function delAcc(){showModal("Confirm",t('delete_confirm'),[{text:"Cancel"},{text:t('delete_btn'),class:"g-btn-primary",onClick:async()=>{closeModal();await fetch('/api/delete_stake',{method:'POST',body:JSON.stringify({discord_id:dId})});loadStatus(dId)}}])}
        async function activateLicense(){const k=document.getElementById('license-key').value;if(!k)return;try{const res=await fetch('/api/activate',{method:'POST',body:JSON.stringify({discord_id:dId,license_key:k})});if(res.ok){showModal("OK","Activated!");loadStatus(dId)}else{const d=await res.json();showModal(t('modal_err'),d.error)}}catch(e){}}
    </script>
</body>

</html>