<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="nav_contact"></title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/common.css">
    <style>
        .container {
            width: 90%;
            max-width: 600px;
            margin: 30px auto
        }

        h1 {
            color: #00E701;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-bottom: 30px
        }

        .form-group {
            margin-bottom: 25px
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #ccc
        }

        input,
        textarea {
            width: 100%;
            padding: 15px;
            background: #111;
            border: 1px solid #333;
            color: #fff;
            border-radius: 8px;
            box-sizing: border-box
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #00E701;
            color: #000;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            border: none;
            font-size: 1.2rem;
            margin-top: 20px
        }

        .custom-select-wrapper {
            position: relative;
            user-select: none
        }

        .custom-select-trigger {
            padding: 15px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .custom-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #111;
            border: 1px solid #333;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            border-radius: 0 0 8px 8px;
            max-height: 240px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .5)
        }

        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible
        }

        .custom-option {
            padding: 12px 15px;
            cursor: pointer;
            border: 1px solid #222;
            margin: 4px;
            border-radius: 4px;
            transition: .2s;
            color: #ccc;
            background: #1a1a1a;
            display: block
        }

        .custom-option:hover {
            border-color: #00E701;
            color: #00E701
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 data-i18n="nav_contact"></h1>
        <form id="contact-form">
            <div class="form-group"><label data-i18n="category_label"></label>
                <div class="custom-select-wrapper">
                    <div class="custom-select">
                        <div class="custom-select-trigger"><span id="sel-sub" data-i18n="cat_placeholder"></span>
                            <div class="arrow"></div>
                        </div>
                        <div class="custom-options"><span class="custom-option" data-value="pay"
                                data-i18n="cat_pay"></span><span class="custom-option" data-value="prod"
                                data-i18n="cat_prod"></span><span class="custom-option" data-value="err"
                                data-i18n="cat_err"></span><span class="custom-option" data-value="other"
                                data-i18n="cat_other"></span></div>
                    </div><input type="hidden" id="sub-val" required>
                </div>
            </div>
            <div class="form-group" id="ord-grp" style="display:none"><label data-i18n="order_id_label"></label>
                <div class="custom-select-wrapper">
                    <div class="custom-select">
                        <div class="custom-select-trigger"><span id="sel-ord" data-i18n="order_placeholder"></span>
                            <div class="arrow"></div>
                        </div>
                        <div class="custom-options" id="ord-opts"></div>
                    </div><input type="hidden" id="ord-id-val">
                </div>
            </div>
            <div class="form-group"><label data-i18n="detail_label"></label><textarea id="desc" required
                    style="height:150px"></textarea></div>
            <div class="form-group"><label data-i18n="image_label"></label><input type="file" id="img-f"
                    accept="image/*"></div>
            <div id="contact-widget" style="margin-top:20px"></div><button type="submit" class="submit-btn" id="sub-btn"
                data-i18n="submit_btn"></button>
        </form>
    </div>
    <script src="/setting.js"></script>
    <script>
        let sToken=null; window.addEventListener('DOMContentLoaded',async()=>{setupSel();setTimeout(()=>{if(window.turnstile)turnstile.render('#contact-widget',{sitekey:window.TURNSTILE_SITE_KEY,theme:'dark'})},500);if(!window.supabaseApp)await new Promise(r=>setTimeout(r,1000));const {data:{session}}=await window.supabaseApp.auth.getSession();if(session){sToken=session.access_token;loadOs(session.user.id)}else{showModal(t('modal_err'),t('modal_login_req'),[{text:"OK",onClick:()=>location.href="/"}])}});
        function setupSel(){document.querySelectorAll('.custom-select-trigger').forEach(t=>t.onclick=e=>{const p=t.closest('.custom-select');document.querySelectorAll('.custom-select').forEach(s=>{if(s!==p)s.classList.remove('open')});p.classList.toggle('open');e.stopPropagation()});document.addEventListener('click',e=>{if(e.target.classList.contains('custom-option')){const o=e.target,w=o.closest('.custom-select-wrapper');w.querySelector('.custom-select-trigger span').innerText=o.innerText;w.querySelector('input').value=o.getAttribute('data-value');o.closest('.custom-select').classList.remove('open');if(w.querySelector('input').id==='sub-val')document.getElementById('ord-grp').style.display=(o.getAttribute('data-value')==='prod'||o.getAttribute('data-value')==='err')?'block':'none'}else{document.querySelectorAll('.custom-select').forEach(s=>s.classList.remove('open'))}})}
        async function loadOs(uid){try{const res=await fetch('/api/history',{method:'POST',body:JSON.stringify({user_id:uid})});const os=await res.json();const c=document.getElementById('ord-opts');c.innerHTML="";os.forEach(o=>{const s=document.createElement('span');s.className='custom-option';s.innerText=`${o.order_id} (${o.status})`;s.setAttribute('data-value',o.order_id);c.appendChild(s)})}catch(e){}}
        document.getElementById('contact-form').onsubmit=async e=>{e.preventDefault();const tok=turnstile.getResponse();if(!tok)return alert("Captcha.");const btn=document.getElementById('sub-btn');btn.disabled=true;try{const res=await fetch('/api/contact',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${sToken}`},body:JSON.stringify({subject:document.getElementById('sel-sub').innerText,order_id:document.getElementById('ord-id-val').value,description:document.getElementById('desc').value,cf_token:tok})});if(res.ok)showModal("Success","Sent!",[{text:"OK",onClick:()=>location.href="/"}]);else throw new Error("Fail")}catch(e){alert(e.message);btn.disabled=false}};
    </script>
</body>

</html>