<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="purchase_title">購入手続き</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/common.css">
    <style>
        body {
            background: #000;
            color: #fff
        }

        .container {
            width: 90%;
            max-width: 800px;
            margin: 30px auto;
            text-align: center;
            padding-bottom: 50px
        }

        .page-title {
            font-size: 2rem;
            color: #00E701;
            font-weight: bold;
            margin-bottom: 40px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px
        }

        .section-title {
            font-size: 1.2rem;
            margin: 30px 0 15px 0;
            color: #ccc;
            border-left: 4px solid #00E701;
            padding-left: 10px;
            text-align: left
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px
        }

        .select-card {
            background: #111;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: .2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px
        }

        .select-card.selected {
            border-color: #00E701;
            background: rgba(0, 231, 1, .1);
            box-shadow: 0 0 15px rgba(0, 231, 1, .3)
        }

        .select-card.selected::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: -10px;
            right: -10px;
            background: #00E701;
            color: #000;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: .8rem
        }

        .coupon-input {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            background: #0f1a0f;
            border: 2px solid #00E701;
            color: #fff;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box
        }

        .checkout-btn {
            background: #00E701;
            color: #000;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 30px;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px
        }

        .global-modal-box {
            padding: 8px 15px !important;
            max-width: 340px !important;
            border: 1px solid #444 !important
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 1px 0;
            border-bottom: 1px solid #1a1a1a;
            line-height: 1.1
        }

        .price-total {
            border-top: 1px solid #333;
            margin-top: 2px !important;
            padding-top: 2px !important;
            font-size: 1rem;
            color: #00E701;
            font-weight: bold
        }

        #cf-turnstile-container {
            margin: 8px 0;
            display: flex;
            justify-content: center;
            transform: scale(.85);
            height: 60px
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="page-title" data-i18n="purchase_title"></h1>
        <div class="section-title" data-i18n="plan_select"></div>
        <div class="selection-grid" id="plan-grid">
            <div class="select-card" onclick="selectPlan(this,'1day')">1 Day <div
                    style="font-family:monospace;color:#aaa">¥1,200</div>
            </div>
            <div class="select-card" onclick="selectPlan(this,'1week')">1 Week <div
                    style="font-family:monospace;color:#aaa">¥3,000</div>
            </div>
            <div class="select-card" onclick="selectPlan(this,'2weeks')">2 Weeks <div
                    style="font-family:monospace;color:#aaa">¥5,000</div>
            </div>
            <div class="select-card" onclick="selectPlan(this,'1month')">1 Month <div
                    style="font-family:monospace;color:#aaa">¥6,800</div>
            </div>
        </div>
        <div class="section-title" data-i18n="payment_select"></div>
        <div class="selection-grid" id="payment-grid">
            <div class="select-card disabled" style="opacity:.4;pointer-events:none">PayPay<br><small>Soon</small></div>
            <div class="select-card" onclick="selectPayment(this,'crypto')"><i class="fa-brands fa-bitcoin"
                    style="color:#f7931a;font-size:1.5rem"></i>
                <div>Cryptocurrency</div>
            </div>
        </div>
        <input type="text" id="coupon-code" class="coupon-input" data-i18n-placeholder="coupon_placeholder">
        <br><button class="checkout-btn" onclick="verifyOrder()"><i class="fa-solid fa-cart-shopping"></i> <span
                data-i18n="checkout_btn"></span></button>
    </div>
    <script src="/setting.js"></script>
    <script>
        let sPlan=null,sPay=null;
        function selectPlan(el,p){document.querySelectorAll('#plan-grid .select-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');sPlan=p}
        function selectPayment(el,m){document.querySelectorAll('#payment-grid .select-card').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');sPay=m}
        async function verifyOrder(){
            if(!currentUser)return showModal(t('modal_err'),t('modal_login_req'));
            if(!sPlan||!sPay)return showModal(t('modal_err'),"Please select plan and payment.");
            const btn=document.querySelector('.checkout-btn'),orig=btn.innerHTML,coupon=document.getElementById('coupon-code').value;
            btn.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>...';btn.disabled=true;
            try{
                const res=await fetch('/api/create_order',{method:'POST',body:JSON.stringify({action:'check_coupon',user_id:currentUser.id,plan_id:sPlan,coupon_code:coupon})});
                const d=await res.json();
                const html=`<div class="price-row"><span>${t('confirm_plan')}</span><span>${d.plan_name}</span></div><div class="price-row"><span>${t('confirm_method')}</span><span>Crypto</span></div><div class="price-row"><span>${t('confirm_price')}</span><span>¥${d.original_price}</span></div><div class="price-row" style="color:#00E701"><span>${t('confirm_discount')}</span><span>${d.coupon_label||'-¥'+d.discount}</span></div><div class="price-row price-total"><span>${t('confirm_total')}</span><span>¥${d.final_price}</span></div><div style="margin-top:8px;text-align:center"><label style="cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px"><input type="checkbox" id="tos-chk" style="accent-color:#00E701"> <span style="font-size:.8rem">${t('tos_agree_text')} <a href="/terms" target="_blank" style="color:#fff;text-decoration:underline">${t('tos_agree_link')}</a>${currentLang==='ja'?'に同意する':''}</span></label></div><div id="cf-turnstile-container"><div id="turnstile-widget"></div></div>`;
                showModal(t('modal_confirm_title'),html,[{text:t('confirm_back'),onClick:closeModal},{text:t('confirm_pay'),class:"btn-green",onClick:()=>{const chk=document.getElementById('tos-chk'),tok=turnstile.getResponse();if(!chk||!chk.checked)return alert("Agree to terms.");if(!tok)return alert("Captcha.");createOrder(coupon,tok)}}]);
                setTimeout(()=>{if(window.turnstile)turnstile.render('#turnstile-widget',{sitekey:window.TURNSTILE_SITE_KEY,theme:'dark'})},50);
            }catch(e){showModal(t('modal_err'),"Fail");}finally{btn.innerHTML=orig;btn.disabled=false}
        }
        async function createOrder(coupon,tok){try{const res=await fetch('/api/create_order',{method:'POST',body:JSON.stringify({action:'create',user_id:currentUser.id,email:currentUser.email,plan_id:sPlan,coupon_code:coupon,cf_token:tok})});const d=await res.json();if(d.order_id)location.href=`/checkout/${d.order_id}`;else throw new Error(d.error)}catch(e){showModal(t('modal_err'),e.message)}}
    </script>
</body>

</html>