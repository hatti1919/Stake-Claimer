<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="payment_title"></title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="/common.css">
    <style>
        .split-container {
            display: flex;
            flex-wrap: wrap;
            max-width: 1000px;
            width: 95%;
            margin: 40px auto;
            gap: 20px
        }

        .left-col,
        .right-col {
            flex: 1;
            min-width: 300px;
            background: #111;
            border: 1px solid #333;
            padding: 30px;
            border-radius: 15px;
            box-sizing: border-box
        }

        .right-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center
        }

        h2 {
            color: #00E701;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-top: 0;
            width: 100%
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            border-bottom: 1px solid #222;
            padding-bottom: 5px
        }

        .pay-btn {
            background: #00E701;
            color: #000;
            text-decoration: none;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            margin: 30px 0;
            display: inline-block
        }

        .key-box {
            font-family: monospace;
            font-size: 1.8rem;
            color: #00ffff;
            border: 2px dashed #00E701;
            padding: 20px;
            margin: 20px 0;
            word-break: break-all;
            background: #000;
            border-radius: 10px
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #00E701;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .timer-display {
            font-family: monospace;
            font-size: 1.5rem;
            color: #ff4444;
            margin-top: 15px;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 8px;
            background: #0a0a0a
        }

        .help-box {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid #333;
            width: 100%;
        }

        .reload-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .reload-btn:hover {
            background: #444;
        }
    </style>
</head>

<body>
    <div class="split-container">
        <div class="left-col">
            <h2 data-i18n="order_detail"></h2>
            <div class="info-row"><span>Order ID</span><span id="disp-oid" style="font-family:monospace">...</span>
            </div>
            <div class="info-row"><span data-i18n="plan_label"></span><span id="disp-plan">-</span></div>
            <div class="info-row"><span data-i18n="confirm_total"></span><span id="disp-amount">-</span></div>
        </div>
        <div class="right-col" id="pending-view">
            <h2 data-i18n="payment_title"></h2>
            <p data-i18n="pay_info"></p>
            <a id="pay-link" href="#" target="_blank" class="pay-btn" data-i18n="pay_link_btn"></a>
            <div class="spinner"></div>
            <div id="status-text" style="color:#ffd700;font-weight:bold" data-i18n="waiting_pay"></div>
            <div class="timer-display" id="timer">--:--</div>
            <div class="help-box">
                <p data-i18n="pay_help_title" style="font-weight:bold; margin:0;"></p>
                <button class="reload-btn" onclick="location.reload()"><i class="fa-solid fa-rotate"></i> <span
                        data-i18n="pay_help_reload"></span></button>
                <p style="font-size:0.85rem; color:#888; margin-top:15px;">
                    <span data-i18n="pay_help_msg"></span> <a href="/contact"
                        style="color:#00E701; text-decoration:underline;" data-i18n="nav_contact"></a>
                </p>
            </div>
        </div>
        <div class="right-col" id="success-view" style="display:none"><i class="fa-solid fa-circle-check"
                style="font-size:5rem;color:#00E701;margin-bottom:20px"></i>
            <h2 data-i18n="success_title"></h2>
            <p data-i18n="key_issued"></p>
            <div id="license-key" class="key-box"></div><a href="/dashboard" class="pay-btn"
                data-i18n="use_now_btn"></a>
        </div>
    </div>
    <script src="/setting.js"></script>
    <script>
        const path = window.location.pathname.split('/'); let oid = path.pop() || path.pop();
        window.addEventListener('DOMContentLoaded',async()=>{if(!window.supabaseApp)await new Promise(r=>setTimeout(r,1000));const {data:{session}}=await window.supabaseApp.auth.getSession();if(session){try{const res=await fetch('/api/history',{method:'POST',body:JSON.stringify({user_id:session.user.id})});const os=await res.json();const t=os.find(o=>o.order_id===oid);if(t){document.getElementById('disp-oid').innerText=oid;document.getElementById('disp-plan').innerText=t.plan_type.toUpperCase();document.getElementById('disp-amount').innerText="Â¥"+t.final_amount;if(t.status==='paid')showS(t.license_key);else{document.getElementById('pay-link').href=t.pay_url;startP(session.user.id);startT(t.created_at)}}}catch(e){}}});
        function startP(uid){setInterval(async()=>{try{const res=await fetch('/api/check_order',{method:'POST',body:JSON.stringify({order_id:oid,user_id:uid})});const d=await res.json();if(d.status==='paid')showS(d.license_key)}catch(e){}},3000)}
        function startT(cStr){const expire=new Date(cStr).getTime()+(60*60*1000);function up(){const diff=expire-new Date().getTime();if(diff<=0){clearInterval(cInt);return}const m=Math.floor((diff%(1000*60*60))/(1000*60)),s=Math.floor((diff%(1000*60))/1000);document.getElementById('timer').innerText=`${t('timer_label')}: ${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`}up();cInt=setInterval(up,1000)}
        function showS(k){document.getElementById('pending-view').style.display='none';document.getElementById('success-view').style.display='flex';document.getElementById('license-key').innerText=k}
    </script>
</body>

</html>