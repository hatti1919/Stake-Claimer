<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お支払い</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/common.css">
    <style>
        .split-container {
            display: flex;
            flex-wrap: wrap;
            max-width: 1000px;
            width: 95%;
            margin: 40px auto;
            gap: 20px;
        }

        .left-col,
        .right-col {
            flex: 1;
            min-width: 300px;
            background: #111;
            border: 1px solid #333;
            padding: 30px;
            border-radius: 15px;
            box-sizing: border-box;
        }

        .right-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        h2 {
            color: #00E701;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
            margin-top: 0;
            width: 100%;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            border-bottom: 1px solid #222;
            padding-bottom: 5px;
        }

        .info-label {
            color: #aaa;
        }

        .info-val {
            font-family: monospace;
            font-size: 1.1rem;
        }

        /* 割引表示用のスタイル追加 */
        .discount-val {
            color: #00E701;
            font-weight: bold;
        }

        .strike-text {
            text-decoration: line-through;
            color: #666;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .pay-btn {
            background: #00E701;
            color: #000;
            text-decoration: none;
            font-weight: bold;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            margin: 30px 0;
            transition: 0.3s;
            display: inline-block;
        }

        .pay-btn:hover {
            box-shadow: 0 0 20px rgba(0, 231, 1, 0.5);
            transform: scale(1.05);
        }

        .trouble-link {
            color: #666;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 30px;
        }

        .reload-btn {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .key-box {
            font-family: monospace;
            font-size: 1.8rem;
            color: #00ffff;
            border: 2px dashed #00E701;
            padding: 20px;
            margin: 20px 0;
            word-break: break-all;
            background: #000;
            border-radius: 10px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-top: 4px solid #00E701;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .timer-display {
            font-family: monospace;
            font-size: 1.5rem;
            color: #ff4444;
            margin-top: 15px;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 8px;
            background: #0a0a0a;
        }
    </style>
</head>

<body>
    <div class="split-container">
        <div class="left-col">
            <h2>注文詳細</h2>
            <div class="info-row">
                <span class="info-label">Order ID</span>
                <span class="info-val" id="disp-oid">Loading...</span>
            </div>
            <div class="info-row">
                <span class="info-label">プラン</span>
                <span class="info-val" id="disp-plan">-</span>
            </div>

            <div class="info-row" id="row-original" style="display:none;">
                <span class="info-label">定価</span>
                <span class="info-val" id="disp-original"></span>
            </div>
            <div class="info-row" id="row-discount" style="display:none;">
                <span class="info-label">割引</span>
                <span class="info-val discount-val" id="disp-discount"></span>
            </div>
            <div class="info-row">
                <span class="info-label">支払金額</span>
                <span class="info-val" id="disp-amount">-</span>
            </div>

            <p style="color:#666; font-size:0.9rem; margin-top:30px;">
                お支払いが完了すると、右側の画面が自動的に切り替わりライセンスキーが表示されます。<br>
                この画面を閉じても、購入履歴からいつでも確認できます。
            </p>
        </div>

        <div class="right-col" id="pending-view">
            <h2>お支払い</h2>
            <div id="payment-active-area">
                <p>以下のボタンから決済ページへ進んでください。</p>
                <a id="pay-link" href="#" target="_blank" class="pay-btn">支払う</a>

                <div style="margin-top:20px;">
                    <div class="spinner"></div>
                    <div id="status-text" style="color:#ffd700; font-weight:bold;">入金待ち...</div>
                </div>

                <div class="timer-display" id="countdown-timer">残り時間: --:--</div>
            </div>

            <div id="expired-area" style="display:none; color:#ff4444; margin-top:20px; text-align:center;">
                <i class="fa-solid fa-circle-xmark" style="font-size:4rem; margin-bottom:15px;"></i>
                <h3>期限切れ</h3>
                <p style="margin-bottom:20px; font-weight:bold;">この注文はキャンセルになりました。</p>
                <a href="/purchase" class="pay-btn"
                    style="background:#333; color:#fff; border:1px solid #555; font-size:1rem; padding: 12px 25px;">
                    新しい注文はこちら
                </a>
            </div>

            <div class="trouble-link" onclick="document.getElementById('trouble-area').style.display='block'">
                支払いが完了したのに反映されませんか？</div>
            <div id="trouble-area" style="display:none; margin-top:15px; border-top:1px solid #222; padding-top:15px;">
                <button class="reload-btn" onclick="location.reload()">ページを再読み込み</button>
                <p style="font-size:0.8rem; color:#666;">それでも解決しない場合は <a href="/contact" style="color:#aaa;">お問い合わせ</a>
                    チケットを作成してください。</p>
            </div>
        </div>

        <div class="right-col" id="success-view" style="display:none;">
            <i class="fa-solid fa-circle-check" style="font-size:5rem; color:#00E701; margin-bottom:20px;"></i>
            <h2>支払い完了！</h2>
            <p>ライセンスキーが発行されました。</p>
            <div id="license-key" class="key-box"></div>
            <p style="color:#aaa; font-size:0.9rem;">コピーしてDiscordなどで使用してください。</p>
            <a href="/usage" class="pay-btn" style="background:#333; color:#fff; border:1px solid #555;">使い方を見る</a>
        </div>
    </div>

    <script src="/setting.js"></script>
    <script>
        const pathSegments = window.location.pathname.split('/');
        let orderId = pathSegments.pop() || pathSegments.pop();
        if (!orderId || orderId === 'checkout.html') {
            const params = new URLSearchParams(window.location.search);
            orderId = params.get('order_id');
        }

        document.getElementById('disp-oid').innerText = orderId || "Unknown";
        
        let countdownInterval;

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                if(!window.supabaseApp) await new Promise(r => setTimeout(r, 1000));
                const { data: { session } } = await window.supabaseApp.auth.getSession();
                
                if(session) {
                    try {
                        // 履歴取得APIを叩いて注文詳細を取得
                        const res = await fetch('/api/history', { method: 'POST', body: JSON.stringify({ user_id: session.user.id }) });
                        const orders = await res.json();
                        const target = orders.find(o => o.order_id === orderId);
                        
                        if (target) {
                            document.getElementById('disp-plan').innerText = target.plan_type.toUpperCase();
                            
                            // ★ここから: 割引有無による表示切り替え
                            const original = target.amount || target.final_amount; // 古いデータ互換
                            const discount = target.discount_amount || 0;
                            const final = target.final_amount;

                            if (discount > 0) {
                                // 割引がある場合のみ表示
                                document.getElementById('row-original').style.display = 'flex';
                                document.getElementById('row-discount').style.display = 'flex';
                                document.getElementById('disp-original').innerText = "¥" + original;
                                document.getElementById('disp-discount').innerText = "-¥" + discount;
                            }
                            
                            document.getElementById('disp-amount').innerText = "¥" + final;
                            // ★ここまで

                            if(target.status === 'paid') {
                                showSuccess(target.license_key);
                            } else if(target.status === 'expired') {
                                showExpired();
                            } else {
                                document.getElementById('pay-link').href = target.pay_url;
                                startPolling(session.user.id);
                                startTimer(target.created_at);
                            }
                        } else {
                            document.querySelector('.split-container').innerHTML = `
                                <div style="text-align:center; padding:50px;">
                                    <h2 style="color:#fff;">注文が見つかりません</h2>
                                    <p>ID: ${orderId}</p>
                                    <a href="/history" style="color:#00E701;">購入履歴に戻る</a>
                                </div>`;
                        }
                    } catch(e) { console.error(e); }
                } else {
                    alert("ログインしてください");
                    window.location.href = "/";
                }
            } catch(e) { console.log("Init wait"); }
        });

        function startPolling(uid) {
            const interval = setInterval(async () => {
                try {
                    const res = await fetch('/api/check_order', { method: 'POST', body: JSON.stringify({ order_id: orderId, user_id: uid }) });
                    const data = await res.json();
                    
                    if(data.status === 'paid') {
                        clearInterval(interval);
                        clearInterval(countdownInterval);
                        showSuccess(data.license_key);
                    } else if (data.status === 'expired') {
                        clearInterval(interval);
                        clearInterval(countdownInterval);
                        showExpired();
                    }
                } catch(e){}
            }, 3000);
        }

        // タイマー関数 (1時間 = 3600秒)
        function startTimer(createdAtStr) {
            const created = new Date(createdAtStr).getTime();
            const expireTime = created + (60 * 60 * 1000); 

            function update() {
                const now = new Date().getTime();
                const diff = expireTime - now;

                if (diff <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown-timer').innerText = "残り時間: 00:00";
                    showExpired(); 
                    return;
                }

                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('countdown-timer').innerText = `残り時間: ${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }

            update(); 
            countdownInterval = setInterval(update, 1000);
        }

        function showSuccess(key) {
            document.getElementById('pending-view').style.display='none';
            document.getElementById('success-view').style.display='flex';
            document.getElementById('license-key').innerText = key;
        }

        function showExpired() {
            document.getElementById('payment-active-area').style.display = 'none'; 
            document.getElementById('expired-area').style.display = 'block'; 
        }
    </script>
</body>

</html>